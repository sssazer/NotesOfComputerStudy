# 1. JDBC概述

## 1.1 JDBC原理

JDBC就是一个接口，为访问不同的数据库提供了统一规范，为使用者屏蔽了细节问题。

各数据库都各自实现了JDBC接口，所以可以直接使用JDBC连接任何提供了JDBC驱动程序的数据库系统，并完成对数据库的各种操作

![](./5/1.JDBC示意图.png)

其中各个厂商对Java提供接口的实现都会打包为一个.jar驱动文件，需要这个驱动文件才能使用Java操作相应的数据库

JDBC相关类和接口在 `java.sql` 和 `javax.sql` 包中

## 1.2 QuickStart

0. 下载并配置驱动文件

   [下载](https://downloads.mysql.com/archives/c-j/)`mysql-connector-j-version.jar`文件

   在项目文件夹下新建文件夹并将.jar文件复制进去，之后右键.jar文件选择add as library

1. 注册驱动

   ```java
   import com.mysql.jdbc.Deiver; // 这个包在刚刚加载的.jarw
   
   Driver driver = new Driver();
   ```

2. 连接数据库

   ```java
   // 1. 指定数据库地址：
   // 格式说明：jdbc:mysql://ip地址:端口号/数据库名
   String url = "jdbc:mysql://localhost:3306/jdbctestdb1";
   // 2. 封装登录用户
   // 用一个Properties对象封装登录的用户名和密码，key固定为"user"和"password"
   Properties properties = new Properties();
   properties.setProperty("user", "root");
   properties.setProperty("password", "wangyize201");
   
   // 建立连接
   Connection connect = driver.connect(url, properties);
   ```

3. 执行sql语句

   执行sql语句需要用到Statement对象，它用于执行静态SQL语句并返回其生成的结果

   ```java
   // 获取Statement对象
   Statement statement = connect.createStatement();
   // 执行SQL语句
   String sql = "insert into customer values("Tom", 18, true)";
   int rows = statement.executeUpdate(sql); // dml语句返回值是影响行数
   ```

4. 关闭连接资源

   ```java
   statement.close();
   connect.close();
   ```


## 1.3 Statement对象

Statement对象用于执行静态SQL语句并返回执行结果，但是在开发中一般不使用该类，因为有SQL注入的风险

### 1.3.1 SQL注入

SQL注入指用户在输入的字符串中注入SQL指令，如果服务器不加检查地当作正常SQL语句执行，就会遭到破坏和入侵

比如：

```SQL
-- 登录验证时
-- userName 和 passWord 是用户输入的字符串，则SQL语句为
strSQL = "SELECT * FROM users WHERE name = '" + userName + "' and pwd = '" + passWord + "'";

-- 如果用户填入的userName 和 passWord为
userName = "1' OR '1' = 1";
passWord = "1' OR '1' = 1";
-- 那么最后将userName和passWord填入后，最后组成的SQL语句为
SELECT * FROM users
WHERE name = '1' OR '1' = '1'
and pwd = '1' OR '1' = '1';
-- 也就是说一定会查询出结果通过验证，这样就可以达到无账号密码登录网站的效果
```

要防范SQL注入，需要使用PreparedStatement来代替Statement

### 1.3.2 PreparedStatement

PreparedStatement是一个接口，继承于Statement接口

1. 创建SQL语句

   将需要动态指定的部分用 ？占位符 表示，之后再使用PreparedStatement对象的set方法填入

   ```java
   String sql = "select name, pwd from admin where name = ? and pwd = ?";
   ```

2. 通过SQL语句创建PreparedStatement对象

   也就是说PreparedStatement对象和sql语句是相互关联的

   ```java
   PreparedStatement preparedStatement = connect.preparedStatement(sql);
   ```

3. 给 ？赋值

   使用set方法，第一个参数是当前设置的是第几个？（索引从1开始），第二个参数是要设置的值

   ```java
   preparedStatement.setString(1, admin_name);
   preparedStatement.setString(2, admin_pwd);
   ```

4. 执行语句

   - executeQuery执行SELECT语句，返回查询ResultSet类型结果集
   - executeUpdate执行DML语句，返回执行后影响的行数

   ```java
   ResultSet resultSet = preparedStatement.executeQuery();
   ```

# 2. JDBC使用

## 2.1 连接数据库

五种方式连接数据库，推荐使用靠后的连接方式

连接数据库中时用到的信息

```java
String url = "jdbc:mysql://localhost:3306/jdbctestdb1";
Properties loginUser = new Properties();
String user = "root";
String password = "wangyize201";
loginUser.setProperty("user", user);
loginUser.setProperty("password", password);
```

1. 直接创建Driver对象

   ```java
   Driver driver = new Driver();
   Connection connect = driver.connect(url, loginUser);
   ```

2. 通过反射的方式动态加载Driver对象

   ```java
   // 获得Driver对象
   Class<?> driverClass = Class.forName("con.mysql.jdbc.Driver");
   Driver driver = (Driver)driverClass.newInstance();
   // 连接数据库
   Connection connect = driver.connect(url, loginUser);
   ```

3. 使用DriverManager

   DriverManager类用于管理一组JDBC驱动程序的基本服务

   ```java
   // 获得Driver对象
   Class<?> driverClass = Class.forName("con.mysql.jdbc.Driver");
   Driver driver = (Driver)driverClass.newInstance();
   // 注册Driver驱动
   DriverManager.registerDriver(driver);
   // 连接数据库
   Connection connect = DriverManager.getConnection(url, user, password);
   ```

4. 使用DriverManager，但是自动注册Driver驱动

   ```java
   // 加载Driver类
   Class<?> driverClass = Class.forName("con.mysql.jdbc.Driver");
   
   // 连接数据库
   Connection connect = DriverManager.getConnection(url, user, password);
   ```

   - 这是由于在加载Deriver类时，会自动完成注册

     Driver类中有一段静态代码块

   ```java
   static {
       try {
           DriverManager.registerDriver(new Driver());
       } catch (SQLException var1) {
           throw new RuntimeException("Can't register driver!");
       }
   }
   ```

   - 在mysql驱动5.1.6之后无需使用Class.forName加载类即可直接连接数据库

     因为会自动调用驱动jar包下 `META-INF\services\java.dql.Driver`文本文件中的类名称去自动注册

     但还是建议写生forName来手动加载类

5. 使用配置文件读取连接方式url，用户名user和密码password

## 2.2 SELECT语句

### 2.2.1 执行SELECT语句

`ResultSet executeQuery(String sql);`

执行SQL语句，并返回一个ResultSet对象（该对象中就存储了SELECT查询的结果集）

```java
// 假设已经完成连接数据库，取得Connection对象connect
Statement statement = connect.createStatement();
String sql = "SELECT * from myemp1";
ResultSet resultSet = statement.executeQuery(sql);
```

### 2.2.2 ResultSet结果集

ResultSet对象初始指向结果集第一行的上一行，使用next函数可以让光标向下移动一行。如果移动至末尾则next函数返回false

```java
// 比如结果表中字段为 String姓名 int年龄
while (resultSet.next()) {
    String name = resultSet.getString(1); // 获取第一列的数据
    int age = resultSet.getInt(2); // 获取第二列的数据
}
```

**常用方法**

- next() \ previous()

  向下\向上移动一行

- getXxx(int columnIndex)

  获取当前ResultSet对象指向行的指定列索引的值，Xxx为该值的数据类型

  getXxx(String columnLabel)

  也可以通过执行列名来获取指定数据

- getObject(int columnIndex) \ getObject(String columnLabel)

  将数据取出为Object类型

## 2.3 事务

默认情况下JDBC是自动提交，即执行完executeUpdate语句并发送到SQL数据库之后，就直接提交且不可回滚了

如果需要多条语句一起执行，就需要关闭自动提交并自己手动提交

- 设置不自动提交

  `connection.setAutoCommit(false);`

- 提交

  `connection.commit();`

- 回滚

  `connection.rollback();`

比如一个经典的交易案例

```java
Connection connection = null;
PreparedStatement preparedStatement = null;
// id为1的用户转给id为2的用户100块
String sql1 = "update account set balance = balance - 100 where id = 1";
String sql2 = "update account set balance = balance + 100 where id = 2";
// 交易过程
try {
    connection = DriverManager.getConnection(url, name, pwd);
    connection.setAutoCommit(false);
    // 执行第一条SQL语句
    preparedStatement = connection.prepareStatement(sql1);
    preparedStatement.executeUpdate(); 
    
    int i = 1 / 0; // 第一二条语句之间程序出现异常
    
    // 执行第二条SQL语句
    preparedStatement = connection.prepareStatement(sql1);
    preparedStatement.executeUpdate();
    
    // 如果两条语句都执行成功，提交
    connection.commit();
} catch (SQLException e) {
    // 如果执行过程中出现异常就回滚
    connection.rollback();
    throw new RuntimeException(e);
} finally {
    // 关闭资源
    preparedStatement.close();
    connection.close();
}
```

## 2.4 批处理

批处理允许多条语句一次性提交给数据库批量处理，通常情况下比单独提交处理更有效率（因为涉及到网络传输）

**使用批处理的步骤**

1. 在创建Connection时，url最后要加上`?rewriteBathchedStatements=true`

   即`jdbc:mysql://localhost:3306/dbName?rewriteBatchedStatements=true`

2. 将sql语句加入到批处理列表中

   `preparedStatement.addBatch();`

3. 将批处理中的sql语句统一提交给数据库

   `preparedStatement.executeBatch();`

4. 清空批处理列表中的sql语句

   `preparedStatement.clearBatch();`
