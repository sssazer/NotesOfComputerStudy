# 1 事务

最小的工作单元，不可再分

# 2. 索引

索引添加在数据库表的字段上，索引是数据结构，用于提高查询效率

MySQL在查询方面主要有两种方式

- 全表扫面
- 根据索引检索

索引在存储引擎中实现，不同存储引擎实现索引的方式可能不同。在InnoDB中，索引的底层结构是B+Tree

![索引底层B+树](E:\CS\MySql数据库\索引底层B+树.jpg)

## 2.1 常见的索引概念

### 2.1.1 聚簇索引

聚簇索引是一种数据存储方式，表示索引和数据是不分开的，数据就是索引，索引就是数据。就是说数据在底层用B+树这种数据结构存储，本身就构成了一种索引，二者本身也就在同一个文件当中

由于数据存储方式就是B+树，因此并不需要显示添加或者创建索引，当往表中添加第一条记录的时候，InnoDB引擎会自动创建聚簇索引。

**特点：**

- 由于数据物理存储的顺序只能有一种，所以每个MySQL表只能有一个聚簇索引，一般是这个表的主键。所以每个表只能有一个主键
- 如果没有定义主键，但是B+树又必须要求一个排序方式，那么InnoDB会选择一个非空唯一索引代替，如果也没有，就会隐式定义一个主键来作为聚簇索引

### 2.1.2 二级索引（辅助索引、非聚簇索引）

聚簇索引只有在搜索条件是主键值时才能发挥作用，如果想以别的列作为搜索条件该怎么办？

可以多建几颗B+树，不同的B+树采用不同的列作为排序规则。

这种B+树（非聚簇索引）不会存储完整的数据，一般只会存储该条记录的主键值，然后再通过主键值去聚簇索引中查找，这个过程就称为**回表**——需要查找两棵B+树才能得到完成数据记录

非主键可能有重复，但是B+树中要保证目录项中的结点（非叶子结点，称为内节点）值必须唯一，所以对于值相同的目录项结点，会额外添加上主键保证唯一。

### 2.1.3 联合索引

联合索引实际上也是非聚簇索引，只不过是同时以多个列的大小作为排序规则

比如说同时以C1和C2列作为联合索引，就先按照C1列排序，C1列相同的情况下再按照C2排列。

此时叶结点中存储的数据就是联合索引包含的列+主键

## 2.2 不同引擎中的索引方案

在MyISAM、InnoDB、Memory三个引擎中都支持B-Tree索引（实际上是B+Tree，不过国外统称B-Tree）。但是实现原理不同

- MyISAM：默认BTree，叶子结点data域存放的是数据记录的地址
- InnoDB：默认BTree，叶子结点data域存放的是数据记录本身
- Memory：默认使用Hash索引

### 2.2.1 MyISAM

索引和数据是分开的，所以用MyISAM引擎存储的表有两个文件。MYD文件存储数据，MYI文件存储索引。索引使用B+Tree，但是叶子结点存储的是数据记录的地址。

![MyISAM索引](E:\CS\MySql数据库\MyISAM索引.jpg)

由于在MyISAM中索引和数据是分开的，所以其实MyISAM是不支持聚簇索引的，它所有的索引实际上都是非聚簇索引。

在插入数据的过程中，也不会将数据直接按照B+Tree排序，而是直接按照插入顺序往文件里面塞

### 2.2.2 InnoDB

索引和数据存储在一起，一个表对应一个.ibd文件，数据直接存储在B+Tree的叶子结点中。

InnoDB一定有一个聚簇索引（一定有一个主键），因为索引即数据，数据即索引。从插入第一个数据开始就是按照B+Tree的顺序排列的

根据B+Tree的特性，在指定主键时就要注意以下几点：

- 不要使用过长的字段作为主键：

  - 这样会使得非叶子结点能容纳的目录项变少，增加读盘次数；

  - 也会使得二级索引变大，因为二级索引要存储主键

- 要用自增字段作为主键

  不然插入新纪录时，会为了维持B+Tree的特性而频繁分裂调整